var moveInProg=!1,deleteInProg=!1,currentDir="",view="",serach="";$(function(){function e(e,t,i,r){$.get(ajaxPath+e,function(e){i?r(e):$(t).html(e)})}function t(){var e={},t=1,i="";""!=currentDir&&(i="dir="+currentDir+"&"),e[0]=$(".moveTo").attr("data-path"),$(".moveInProg").each(function(){e[t]=$(this).attr("data-type")+":"+$(this).attr("data-path"),t++}),$.post(ajaxPath+"/movefiles?"+i,e).done(function(e){alert("Files Moved")}),console.log(e)}function i(){var e={},t=1,i="";""!=currentDir&&(i="dir="+currentDir+"&"),$(".selected").each(function(){e[t]=$(this).attr("data-type")+":"+$(this).attr("data-path"),t++}),$.post(ajaxPath+"/deletefiles?"+i,e).done(function(e){alert("Files Deleted")}),console.log(e)}function r(e){FileAPI.each(e,function(e){if(e.size>=25*FileAPI.MB)alert("Sorry.\nMax size 25MB");else if(void 0===e.size)$("#uploader").html("Your browser is not supported.");else{var t=FileAPI.uid(e),i=$(".file-upload-template").clone();i.removeClass("hide").removeClass("file-upload-template"),i.attr("id","file-"+t),i.find(".stop-upload").attr("data-id","file-"+t),i.find(".dissmiss-file-uploading").attr("data-id","file-"+t),i.find(".desc").html(e.name+" "+(e.size/FileAPI.KB).toFixed(2)+" KB"),i.find(".uploading-icon i").addClass(d.icon[e.type.split("/")[0]]||d.icon.def),$(".file-upload-list").append(i),d.add(e),d.start()}})}function a(e,t){$(".content-page").addClass("hide"),$(e).removeClass("hide"),$(".display-title").html(t)}function l(){var e=0;$(".selected").each(function(){e++}),e>0?$("#move, #delete").removeClass("disabled"):$("#move, #delete").addClass("disabled")}function s(e){var t=e.attr("data-path"),i=$(".def");""!=currentDir&&(t=currentDir+DS+t),i.find(".defid").html(e.find("i").clone()),i.find("p").removeClass("hide").html("Double click to browse folder"),i.find("table").addClass("hide")}function o(e){var t=e.attr("data-path"),i=e.attr("data-ext"),r=$(".def");if($.inArray(i,imgFormats)>-1){var a='<img src="'+filesUrl+t+'" alt="defimg" class="img-responsive"/>';r.find(".defid").html(a)}else if($.inArray(i,vidFormats)>-1){var l='<video width="100%" height="100%" controls><source src="'+filesUrl+t+'" type="video/mp4"><source src='+filesUrl+t+'" type="video/ogg">Your browser does not support the video tag.</video>';r.find(".defid").html(l)}else if($.inArray(i,audFormats)>-1){var s='<audio controls><source src="'+filesUrl+t+'" type="audio/ogg"><source src="'+filesUrl+t+'" type="audio/mpeg">Your browser does not support the audio element.</audio>';r.find(".defid").html(s)}else r.find(".defid").html(e.find("i").clone());r.find(".fi-mtime").html(e.find(".fr-mtime").html()),r.find(".fi-size").html(e.find(".fr-size").html()),r.find(".fi-title").html(e.find(".name").html()),r.find(".fi-url a").attr("href",filesUrl+t),r.find("p").addClass("hide"),r.find("table").removeClass("hide"),iframe&&r.find(".insert").removeClass("hide").attr("data-path",filesUrl+t)}var d={icon:{def:"fa fa-file",image:"fa fa-picture-o",audio:"fa fa-file-audio-o",video:"fa fa-film"},files:[],index:0,active:!1,add:function(e){d.files.push(e),/^image/.test(e.type)&&FileAPI.Image(e).preview(40).rotate("auto").get(function(t,i){t||d._getEl(e,".uploading-icon").html(i)})},getFileById:function(e){for(var t=d.files.length;t--;)if(FileAPI.uid(d.files[t])==e)return d.files[t]},start:function(){!d.active&&(d.active=d.files.length>d.index)?d._upload(d.files[d.index]):$("#refresh").click()},abort:function(e){var t=this.getFileById(e);t.xhr&&t.xhr.abort()},_getEl:function(e,t){var i=$("#file-"+FileAPI.uid(e));return t?i.find(t):i},_upload:function(e){var t="";""!=currentDir&&(t="?dir="+currentDir),e&&(e.xhr=FileAPI.upload({url:uploadUrl+t,files:{file:e},upload:function(){},progress:function(t){d._getEl(e,".progress-bar").css("width",t.loaded/t.total*100+"%"),d._getEl(e,".file-progress").html((t.loaded/t.total*100).toFixed(0)+"% Done")},complete:function(t,i){data=JSON.parse(i.response);var r="Done";(t||"Failed"==data.msg)&&(r=data.msg,d._getEl(e,".progress-bar").addClass("progress-bar-danger")),d._getEl(e,".file-upload-speed").html("<b>"+r+"</b>"),d._getEl(e,".uploadReason").html(data.reason),d.index++,d.active=!1,d.start()}}))}};$("#upload").click(function(e){a("#uploader","Upload"),e.preventDefault()}),$("#upload").click(function(e){a("#uploader","Upload"),e.preventDefault()}),FileAPI.support.cors||FileAPI.support.flash||$("#uploader").html("Your browser is not supported."),FileAPI.support.dnd&&($("#drag-n-drop").removeClass("hide"),$(document).dnd(function(e){e?$("#drag-n-drop").find("h1").html("Drop"):$("#drag-n-drop").find("h1").html("DRAG N DROP FILES HERE")},function(e){r(e)})),$("#choose").on("change",function(e){var t=FileAPI.getFiles(e);r(t),FileAPI.reset(e.currentTarget)}),$(document).on("click",".stop-upload",function(e){d.abort($(this).attr("data-id").split("-")[1]),e.preventDefault()}),$(document).on("click",".dissmiss-file-uploading",function(e){var t="#"+$(this).attr("data-id");$(t).remove(),e.preventDefault()});var n="";$("#refresh").click(function(t){var i="";""!=currentDir&&(i="dir="+currentDir);var r="";""!=view&&(r="&view="+view);var a="";search.length>2&&(a="&search="+search),""!=n?e("/getfiles?"+i+"&filter="+n+r+a,"#library",!1):e("/getfiles?"+i+r+a,"#library",!1),$("#move, #delete").addClass("disabled"),t.preventDefault()}),$("#refresh").click(),$(".libcontent").click(function(e){var t=$(this).attr("href");switch(n=t.substring(1),"sort-everything"==n&&(n=""),$(this).siblings().removeClass("active"),$(this).addClass("active"),t){case"#sort-image":a("#library","Images");break;case"#sort-video":a("#library","Videos");break;case"#sort-audio":a("#library","Audios");break;case"#sort-docs":a("#library","Documents");break;default:a("#library","Everything")}$("#refresh").click(),e.preventDefault()}),$(document).on("click",".file-list-table tr",function(e){moveInProg&&($("#move").html('<i class="fa fa-check"></i> Done'),$("#move").addClass("done").removeClass("cancel"),$(this).addClass("moveTo"),$(".selected").addClass("moveInProg")),e.ctrlKey&&!moveInProg?$(this).hasClass("selected")?$(this).removeClass("selected"):($(this).addClass("selected"),$(".def").find("p").html("Multiple Items Selected").removeClass("hide"),$(".def").find("table").addClass("hide")):($(this).siblings().removeClass("selected"),$(this).addClass("selected"),$(this).hasClass("dir-row")?s($(this)):o($(this))),l(),e.preventDefault()}),$("#move").click(function(e){$(this).hasClass("disabled")||($(this).hasClass("cancel")?($(this).removeClass("cancel"),$("#move").html('<i class="fa fa-reply-all fa-2"></i> Move').addClass("disabled"),$("#refresh").click(),moveInProg=!1):$(this).hasClass("done")?(t(),$(this).removeClass("done"),$("#move").html('<i class="fa fa-reply-all fa-2"></i> Move'),$("#refresh").click(),moveInProg=!1):($(".file-row").addClass("hide"),$(".dir-row.selected").hide(),moveInProg=!0,$(this).html('<i class="fa fa-ban"></i> Cancel'),$(this).addClass("cancel"))),e.preventDefault()}),$("#delete").click(function(e){$(this).hasClass("disabled")||(confirm("Are you sure you want to DELETE files or/and Directories?")?(i(),$("#refresh").click()):$("#refresh").click()),e.preventDefault()}),$("#addfolder").popover({html:!0,content:function(){return'<div class="form-inline add-folder-popover"><input type="text" class="form-control" id="folder-name" placeholder="Folder Name"><button class="btn btn-primary" id="add-folder">Add</button></div>'},placement:"bottom",title:"Add a Folder",trigger:"click"}),$(".chview").click(function(e){$(".chview").removeClass("active"),$(this).addClass("active"),view=$(this).attr("id"),"rows"==view&&(view=""),$("#refresh").click(),e.preventDefault()}),$(document).on("click","#add-folder",function(t){var i="";""!=currentDir&&(i="dir="+currentDir+"&");var r=$("#folder-name").val();""!=r&&($("#addfolder").click(),e("/addfolder?"+i+"&dirname="+r,"",!0,function(e){$("#refresh").click()})),t.preventDefault()}),$(document).on("click",".cddir",function(e){if($(this).hasClass("last"))return void $("#refresh").click();var t=$(this).attr("data-path");t==DS?(currentDir="",$("#refresh").click()):(currentDir=t,$("#refresh").click())}),$(document).on("dblclick",".dir-row",function(e){var t=$(this).attr("data-path");if($(this).hasClass("parent"))if(""==currentDir)currentDir=DS;else{var i=currentDir.split(DS);i.pop(),currentDir=i.join(DS)}else currentDir=""==currentDir?t:t;$("#refresh").click(),e.preventDefault()});var c,f=500;$("#search").keyup(function(e){clearTimeout(c);var t=$(this).val();c=setTimeout(function(){t.length>2?(search=t,$("#refresh").click()):(search="",t.length<1&&$("#refresh").click())},f),e.preventDefault()}),$(".insert").click(function(){var e=$(this).attr("data-path");CKEFuncNum?(window.opener.CKEDITOR.tools.callFunction(CKEFuncNum,e),window.close()):parent.addPath(e)})});